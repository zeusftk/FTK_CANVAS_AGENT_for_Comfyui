import{r as n,u as $,b as X,j as e,d as G,P as B,e as Q,f as V,h as Y,i as R,k as L,B as K,l as Z,C as ee,m as te,n as se,E as ae,o as F,p as re,D as ne,q as oe,s as ie,t as ce,S as le,v as D}from"./index-DNT9Vl18.js";import{T as de}from"./TopMenu-CGgZSjXt.js";import{C as ue}from"./chevron-right-ZHppJ68t.js";var P="Switch",[he,ke]=G(P),[me,pe]=he(P),H=n.forwardRef((a,t)=>{const{__scopeSwitch:o,name:c,checked:d,defaultChecked:l,required:w,disabled:i,value:p="on",onCheckedChange:f,form:g,...b}=a,[x,r]=n.useState(null),y=$(t,S=>r(S)),k=n.useRef(!1),C=x?g||!!x.closest("form"):!0,[v,T]=X({prop:d,defaultProp:l??!1,onChange:f,caller:P});return e.jsxs(me,{scope:o,checked:v,disabled:i,children:[e.jsx(B.button,{type:"button",role:"switch","aria-checked":v,"aria-required":w,"data-state":M(v),"data-disabled":i?"":void 0,disabled:i,value:p,...b,ref:y,onClick:Q(a.onClick,S=>{T(E=>!E),C&&(k.current=S.isPropagationStopped(),k.current||S.stopPropagation())})}),C&&e.jsx(A,{control:x,bubbles:!k.current,name:c,value:p,checked:v,required:w,disabled:i,form:g,style:{transform:"translateX(-100%)"}})]})});H.displayName=P;var I="SwitchThumb",z=n.forwardRef((a,t)=>{const{__scopeSwitch:o,...c}=a,d=pe(I,o);return e.jsx(B.span,{"data-state":M(d.checked),"data-disabled":d.disabled?"":void 0,...c,ref:t})});z.displayName=I;var fe="SwitchBubbleInput",A=n.forwardRef(({__scopeSwitch:a,control:t,checked:o,bubbles:c=!0,...d},l)=>{const w=n.useRef(null),i=$(w,l),p=V(o),f=Y(t);return n.useEffect(()=>{const g=w.current;if(!g)return;const b=window.HTMLInputElement.prototype,r=Object.getOwnPropertyDescriptor(b,"checked").set;if(p!==o&&r){const y=new Event("click",{bubbles:c});r.call(g,o),g.dispatchEvent(y)}},[p,o,c]),e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:o,...d,tabIndex:-1,ref:i,style:{...d.style,...f,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});A.displayName=fe;function M(a){return a?"checked":"unchecked"}var O=H,ge=z;const U=n.forwardRef(({className:a,size:t="default",...o},c)=>e.jsx(O,{className:R("peer inline-flex shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",{"h-6 w-11":t==="default","h-4 w-8":t==="sm"},a),...o,ref:c,children:e.jsx(ge,{className:R("pointer-events-none block rounded-full bg-background shadow-lg ring-0 transition-transform",{"h-5 w-5 data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0":t==="default","h-3 w-3 data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0":t==="sm"})})}));U.displayName=O.displayName;async function xe(a={}){const{pageSize:t=10,pageNumber:o=1,search:c}=a,d=new URLSearchParams({pageSize:t.toString(),pageNumber:o.toString()});c&&c.trim()&&d.append("search",c.trim());try{const l=await L(`${K}/api/knowledge/list?${d.toString()}`);if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);return await l.json()}catch(l){throw console.error("Failed to get knowledge list:",l),new Error(l instanceof Error?l.message:"Failed to get knowledge list")}}async function we(a){try{const t=await L(`${K}/api/knowledge/${a}`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return(await t.json()).data}catch(t){throw console.error("Failed to get knowledge by id:",t),new Error(t instanceof Error?t.message:"Failed to get knowledge base")}}async function be(a){try{const t=await fetch("/api/settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled_knowledge_data:a})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}catch(t){throw console.error("Failed to save knowledge data to settings:",t),new Error(t instanceof Error?t.message:"Failed to save knowledge data")}}async function je(){try{const a=await fetch("/api/settings");if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return await a.json()}catch(a){return console.error("Failed to get settings:",a),{}}}function ve(){const{t:a}=Z(),[t,o]=n.useState([]),[c,d]=n.useState(!0),[l,w]=n.useState(""),[i,p]=n.useState(1),[f,g]=n.useState(1),[b,x]=n.useState(new Set),[r,y]=n.useState(null),[k,C]=n.useState(!1),v=12;n.useEffect(()=>{(async()=>{try{const j=((await je()).enabled_knowledge_data||[]).map(h=>h.id);x(new Set(j))}catch(u){console.error("Failed to load enabled knowledge from settings:",u)}})()},[]);const T=async(s={})=>{try{d(!0);const u=await xe({pageSize:v,pageNumber:i,search:l.trim()||void 0,...s});o(u.data.list),g(u.data.pagination.total_pages)}catch(u){console.error("Failed to fetch knowledge list:",u),D.error("获取知识库列表失败"),o([])}finally{d(!1)}};n.useEffect(()=>{T({pageNumber:i})},[i]);const S=async(s,u)=>{const m=new Set(b);u?m.add(s):m.delete(s),x(m);try{const j=[];for(const h of m){let N=t.find(_=>_.id===h);if(!N||!N.content)try{console.log(`Fetching full data for knowledge: ${h}`),N=await we(h)}catch(_){console.error(`Failed to fetch knowledge ${h}:`,_),N=t.find(W=>W.id===h)}N&&j.push(N)}await be(j),console.log(`Saved ${j.length} enabled knowledge items to settings`),D.success("知识库设置已保存")}catch(j){console.error("Failed to save knowledge data to settings:",j),D.error("保存知识库设置失败");const h=new Set(b);u?h.delete(s):h.add(s),x(h)}},E=s=>{y(s),C(!0)},q=()=>{i>1&&p(i-1)},J=()=>{i<f&&p(i+1)};return e.jsxs("div",{children:[e.jsx(de,{}),e.jsxs("div",{className:"flex flex-col px-6",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"知识库"}),c&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"加载中..."}),!c&&t.length===0&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:l?"没有找到相关知识库":"暂无知识库"}),!c&&t.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(280px, 1fr))",gap:"16px",marginBottom:"24px"},children:t.map(s=>{const u=b.has(s.id);return e.jsxs(ee,{className:"relative cursor-pointer hover:shadow-md transition-shadow overflow-hidden",children:[s.cover&&e.jsx("div",{className:"w-full h-32 bg-cover bg-center bg-no-repeat",style:{backgroundImage:`url(${s.cover})`},onClick:()=>E(s)}),e.jsx(te,{className:(s.cover,"pb-2"),children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold truncate flex-1 mr-2",onClick:()=>E(s),children:s.name}),e.jsx(U,{checked:u,onCheckedChange:m=>S(s.id,m),className:"flex-shrink-0",onClick:m=>m.stopPropagation()})]})}),e.jsxs(se,{className:"pt-0",onClick:()=>E(s),children:[s.description&&e.jsx("p",{className:"text-sm text-muted-foreground text-ellipsis overflow-hidden",children:e.jsx("span",{className:"block max-h-[3.6em] overflow-hidden leading-6",children:s.description})}),e.jsxs("div",{className:"flex items-center justify-between mt-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:s.is_public?"公开":"私有"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:u?"已启用":"未启用"}),e.jsx(ae,{className:"h-3 w-3 opacity-60"})]})]})]})]},s.id)})}),f>1&&e.jsxs("div",{className:"flex items-center justify-center gap-2 pb-4",children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:q,disabled:i===1,children:[e.jsx(re,{className:"h-4 w-4"}),"上一页"]}),e.jsxs("span",{className:"text-sm text-muted-foreground px-2",children:[i," / ",f]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:J,disabled:i===f,children:["下一页",e.jsx(ue,{className:"h-4 w-4"})]})]})]})]}),e.jsx(ne,{open:k,onOpenChange:C,children:e.jsxs(oe,{className:"max-w-4xl max-h-[80vh] flex flex-col",children:[e.jsx(ie,{children:e.jsxs(ce,{className:"flex items-center gap-2",children:[e.jsx("span",{children:r==null?void 0:r.name}),e.jsxs("span",{className:"text-sm font-normal text-muted-foreground",children:["(",r!=null&&r.is_public?"公开":"私有",")"]})]})}),r&&e.jsxs("div",{className:"flex-1 space-y-4",children:[r.cover&&e.jsx("div",{className:"w-full h-48 rounded-lg overflow-hidden",children:e.jsx("img",{src:r.cover,alt:r.name,className:"w-full h-full object-cover",onError:s=>{s.currentTarget.style.display="none"}})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"创建时间："}),e.jsx("span",{children:new Date(r.created_at).toLocaleString("zh-CN")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"更新时间："}),e.jsx("span",{children:new Date(r.updated_at).toLocaleString("zh-CN")})]})]}),r.description&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"描述"}),e.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed",children:r.description})]}),r.content&&e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium mb-2",children:"内容"}),e.jsx(le,{className:"h-[400px] w-full rounded-md border p-4",children:e.jsx("pre",{className:"text-sm whitespace-pre-wrap break-words",children:r.content})})]}),!r.content&&e.jsx("div",{className:"flex-1 flex items-center justify-center py-12",children:e.jsx("p",{className:"text-muted-foreground",children:"暂无内容"})})]})]})})]})}const Ce=function(){return e.jsx(ve,{})};export{Ce as component};
